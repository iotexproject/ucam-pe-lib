#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/time.h>

#include "ioecr/hmac.h"
#include "emulation.h"

#define FRAMELEN 4096
#define SNAPSHOTLEN 1024
unsigned char framebuf[FRAMELEN];
unsigned char snapshotbuf[SNAPSHOTLEN];

int Emulation_get_frame_info(st_frame_info* frameinfo) {
  int i = 0;
  for (i = 0; i < FRAMELEN; i++) framebuf[i] = 'a' + i % 26;
  frameinfo->buffer = framebuf;
  frameinfo->size = FRAMELEN;
  frameinfo->pts = 1;
  return 1;
}

st_emu_context g_emu_ctx;

unsigned int pes_position[] = {
    0x0,      0x7DC8,   0x7F2C,   0x8090,   0x81F4,   0x8358,   0x9085,
    0x91E9,   0x9E9A,   0x9FFE,   0xA162,   0xACAC,   0xAE10,   0xAF74,
    0xB0D8,   0xBBDE,   0xBD42,   0xC8EC,   0xCA50,   0xCBB4,   0xD700,
    0xD864,   0xD9C8,   0xDB2C,   0xDC90,   0xE7B6,   0xE91A,   0xF4C4,
    0xF628,   0xF78C,   0x102E4,  0x10448,  0x105AC,  0x10710,  0x11276,
    0x113DA,  0x1153E,  0x12071,  0x121D5,  0x12339,  0x12E94,  0x12FF8,
    0x1315C,  0x132C0,  0x13DB0,  0x13F14,  0x14AA1,  0x14C05,  0x14D69,
    0x158D1,  0x15A35,  0x15B99,  0x15CFD,  0x16804,  0x16968,  0x16ACC,
    0x175CA,  0x1772E,  0x18256,  0x183BA,  0x1851E,  0x18682,  0x187E6,
    0x19501,  0x19665,  0x1A104,  0x1A268,  0x1A3CC,  0x1A530,  0x1AFB8,
    0x1B11C,  0x1B280,  0x1B3E4,  0x1BE7C,  0x1BFE0,  0x1CC9B,  0x1CDFF,
    0x1CF63,  0x1DA82,  0x1DBE6,  0x1DD4A,  0x1DEAE,  0x1E9F6,  0x1EB5A,
    0x1ECBE,  0x1F7EF,  0x1F953,  0x1FAB7,  0x20602,  0x20766,  0x208CA,
    0x213A4,  0x21508,  0x2166C,  0x217D0,  0x22493,  0x225F7,  0x2A46C,
    0x2A5D0,  0x2A734,  0x2A898,  0x2A9FC,  0x2B7E2,  0x2B946,  0x2C515,
    0x2C679,  0x2C7DD,  0x2C941,  0x2D36B,  0x2D4CF,  0x2D633,  0x2E1A3,
    0x2E307,  0x2E46B,  0x2EF5C,  0x2F0C0,  0x2FC6B,  0x2FDCF,  0x2FF33,
    0x30097,  0x301FB,  0x30D77,  0x30EDB,  0x31A6C,  0x31BD0,  0x31D34,
    0x32893,  0x329F7,  0x32B5B,  0x32CBF,  0x3384C,  0x339B0,  0x33B14,
    0x33C78,  0x347B6,  0x35319,  0x3547D,  0x355E1,  0x35745,  0x358A9,
    0x36445,  0x365A9,  0x3670D,  0x371ED,  0x37351,  0x37E83,  0x37FE7,
    0x3814B,  0x382AF,  0x38DF7,  0x38F5B,  0x390BF,  0x39C34,  0x39D98,
    0x39EFC,  0x3AA6C,  0x3ABD0,  0x3AD34,  0x3AE98,  0x3AFFC,  0x3BB94,
    0x3C6FC,  0x3C860,  0x3C9C4,  0x3CB28,  0x3D6A6,  0x3D80A,  0x3D96E,
    0x3DAD2,  0x3E657,  0x3E7BB,  0x3E91F,  0x3F466,  0x3F5CA,  0x400BD,
    0x40221,  0x40385,  0x404E9,  0x40FF7,  0x4115B,  0x412BF,  0x41E14,
    0x41F78,  0x420DC,  0x42C11,  0x42D75,  0x42ED9,  0x4303D,  0x43B6D,
    0x43CD1,  0x43E35,  0x44B4C,  0x44CB0,  0x4CB41,  0x4CCA5,  0x4CE09,
    0x4CF6D,  0x4D0D1,  0x4DEC4,  0x4E028,  0x4EB5F,  0x4ECC3,  0x4EE27,
    0x4EF8B,  0x4FAC9,  0x4FC2D,  0x4FD91,  0x5081D,  0x50981,  0x50AE5,
    0x5165E,  0x517C2,  0x51926,  0x52488,  0x525EC,  0x52750,  0x528B4,
    0x53479,  0x535DD,  0x5417D,  0x542E1,  0x54445,  0x54F1C,  0x55080,
    0x551E4,  0x55348,  0x55E78,  0x55FDC,  0x56140,  0x562A4,  0x56ED7,
    0x57A41,  0x57BA5,  0x57D09,  0x57E6D,  0x57FD1,  0x58AE7,  0x58C4B,
    0x58DAF,  0x5990C,  0x59A70,  0x59BD4,  0x5A70C,  0x5A870,  0x5A9D4,
    0x5AB38,  0x5B639,  0x5B79D,  0x5C2D4,  0x5C438,  0x5C59C,  0x5D0E3,
    0x5D247,  0x5D3AB,  0x5D50F,  0x5D673,  0x5E16D,  0x5E2D1,  0x5EDE5,
    0x5EF49,  0x5F0AD,  0x5FBA7,  0x5FD0B,  0x5FE6F,  0x5FFD3,  0x60AEA,
    0x60C4E,  0x60DB2,  0x6190B,  0x61A6F,  0x6256F,  0x626D3,  0x62837,
    0x6299B,  0x62AFF,  0x63603,  0x63767,  0x643E8,  0x6454C,  0x646B0,
    0x651AA,  0x6530E,  0x65472,  0x655D6,  0x660C0,  0x66224,  0x66388,
    0x66E87,  0x66FEB,  0x6714F,  0x6EF9B,  0x6F0FF,  0x6F263,  0x6F3C7,
    0x7049E,  0x70602,  0x710C9,  0x7122D,  0x71391,  0x714F5,  0x71F16,
    0x7207A,  0x721DE,  0x72342,  0x72E98,  0x72FFC,  0x73B88,  0x73CEC,
    0x73E50,  0x7496F,  0x74AD3,  0x74C37,  0x74D9B,  0x74EFF,  0x75A15,
    0x75B79,  0x766B8,  0x7681C,  0x76980,  0x774C3,  0x77627,  0x7778B,
    0x7829A,  0x783FE,  0x78562,  0x786C6,  0x79201,  0x79365,  0x79F1E,
    0x7A082,  0x7A1E6,  0x7A34A,  0x7A4AE,  0x7AFA1,  0x7B105,  0x7BC9D,
    0x7BE01,  0x7BF65,  0x7CA09,  0x7CB6D,  0x7CCD1,  0x7CE35,  0x7D91E,
    0x7DA82,  0x7DBE6,  0x7E8A9,  0x7EA0D,  0x7F535,  0x7F699,  0x7F7FD,
    0x7F961,  0x7FAC5,  0x805BC,  0x80720,  0x81249,  0x813AD,  0x81511,
    0x82015,  0x82179,  0x822DD,  0x82441,  0x82F7E,  0x830E2,  0x83246,
    0x83D98,  0x83EFC,  0x84A09,  0x84B6D,  0x84CD1,  0x84E35,  0x84F99,
    0x85C83,  0x85DE7,  0x85F4B,  0x86A77,  0x86BDB,  0x876F8,  0x8785C,
    0x879C0,  0x87B24,  0x88668,  0x887CC,  0x88930,  0x89465,  0x895C9,
    0x8972D,  0x914FD,  0x91661,  0x917C5,  0x91929,  0x9275B,  0x928BF,
    0x934D8,  0x9363C,  0x937A0,  0x93904,  0x94307,  0x9446B,  0x945CF,
    0x94733,  0x95268,  0x953CC,  0x95530,  0x960B0,  0x96214,  0x96D20,
    0x96E84,  0x96FE8,  0x9714C,  0x97C2F,  0x97D93,  0x97EF7,  0x98AC8,
    0x98C2C,  0x98D90,  0x9992E,  0x99A92,  0x99BF6,  0x99D5A,  0x9A909,
    0x9AA6D,  0x9ABD1,  0x9B702,  0x9B866,  0x9C383,  0x9C4E7,  0x9C64B,
    0x9C7AF,  0x9C913,  0x9D444,  0x9D5A8,  0x9E097,  0x9E1FB,  0x9E35F,
    0x9EE7E,  0x9EFE2,  0x9F146,  0x9F2AA,  0x9FDE7,  0x9FF4B,  0xA00AF,
    0xA0B60,  0xA0CC4,  0xA0E28,  0xA1ACC,  0xA1C30,  0xA1D94,  0xA1EF8,
    0xA2A38,  0xA2B9C,  0xA3716,  0xA387A,  0xA39DE,  0xA448B,  0xA45EF,
    0xA4753,  0xA48B7,  0xA5358,  0xA54BC,  0xA5620,  0xA5784,  0xA642A,
    0xA6F72,  0xA70D6,  0xA723A,  0xA739E,  0xA7502,  0xA7FFB,  0xA815F,
    0xA82C3,  0xA8E03,  0xA8F67,  0xA90CB,  0xA9B9F,  0xA9D03,  0xA9E67,
    0xA9FCB,  0xAAA6D,  0xAABD1,  0xAB872,  0xAB9D6,  0xABB3A,  0xB397E,
    0xB3AE2,  0xB3C46,  0xB3DAA,  0xB3F0E,  0xB4D0A,  0xB4E6E,  0xB5A4F,
    0xB5BB3,  0xB5D17,  0xB6727,  0xB688B,  0xB69EF,  0xB6B53,  0xB7712,
    0xB7876,  0xB79DA,  0xB8514,  0xB8678,  0xB9169,  0xB92CD,  0xB9431,
    0xB9595,  0xB96F9,  0xBA1DE,  0xBA342,  0xBAE86,  0xBAFEA,  0xBB14E,
    0xBBC79,  0xBBDDD,  0xBBF41,  0xBC0A5,  0xBCBEF,  0xBCD53,  0xBCEB7,
    0xBD9FC,  0xBDB60,  0xBE716,  0xBE87A,  0xBE9DE,  0xBEB42,  0xBECA6,
    0xBF82C,  0xBF990,  0xC04DA,  0xC063E,  0xC07A2,  0xC0906,  0xC1438,
    0xC159C,  0xC1700,  0xC1864,  0xC23D8,  0xC253C,  0xC30BD,  0xC3221,
    0xC3385,  0xC3EE4,  0xC4048,  0xC41AC,  0xC4310,  0xC4E67,  0xC4FCB,
    0xC512F,  0xC5C19,  0xC5D7D,  0xC5EE1,  0xC69F4,  0xC6B58,  0xC6CBC,
    0xC7830,  0xC7994,  0xC7AF8,  0xC7C5C,  0xC87FB,  0xC895F,  0xC9484,
    0xC95E8,  0xC974C,  0xC98B0,  0xC9A14,  0xCA56D,  0xCA6D1,  0xCB187,
    0xCB2EB,  0xCB44F,  0xCBF69,  0xCC0CD,  0xCC231,  0xCC395,  0xCD06F,
    0xCD1D3,  0xCD337,  0xCDE44,  0xCDFA8,  0xD5E5E,  0xD5FC2,  0xD6126,
    0xD628A,  0xD63EE,  0xD713C,  0xD72A0,  0xD7E60,  0xD7FC4,  0xD8128,
    0xD8CEB,  0xD8E4F,  0xD8FB3,  0xD9117,  0xD9C7C,  0xD9DE0,  0xD9F44,
    0xDAB4C,  0xDACB0,  0xDB7A6,  0xDB90A,  0xDBA6E,  0xDBBD2,  0xDBD36,
    0xDC7F9,  0xDC95D,  0xDCAC1,  0xDD666,  0xDD7CA,  0xDD92E,  0xDE4C0,
    0xDE624,  0xDE788,  0xDF26C,  0xDF3D0,  0xDF534,  0xE00CF,  0xE0233,
    0xE0397,  0xE0EE5,  0xE1049,  0xE11AD,  0xE1311,  0xE1475,  0xE1FD4,
    0xE2AFC,  0xE2C60,  0xE2DC4,  0xE2F28,  0xE3AEB,  0xE3C4F,  0xE3DB3,
    0xE3F17,  0xE4A7C,  0xE4BE0,  0xE4D44,  0xE58FF,  0xE5A63,  0xE6551,
    0xE66B5,  0xE6819,  0xE697D,  0xE745F,  0xE75C3,  0xE7727,  0xE824B,
    0xE83AF,  0xE8513,  0xE8FCD,  0xE9131,  0xE9295,  0xE93F9,  0xE9EFB,
    0xEA05F,  0xEA1C3,  0xEAC65,  0xEADC9,  0xEBAE6,  0xEBC4A,  0xEBDAE,
    0xEBF12,  0xEC076,  0xECBBA,  0xECD1E,  0xED7BF,  0xED923,  0xEDA87,
    0xEE5C5,  0xEE729,  0xEE88D,  0xEE9F1,  0xEF4C6,  0xEF62A,  0xEF78E,
    0xF0417,  0xF057B,  0xF06DF,  0xF851A,  0xF867E,  0xF87E2,  0xF8946,
    0xF968F,  0xF97F3,  0xFA3A6,  0xFA50A,  0xFA66E,  0xFB0AA,  0xFB20E,
    0xFB372,  0xFB4D6,  0xFC003,  0xFC167,  0xFC2CB,  0xFC42F,  0xFCF3D,
    0xFDA39,  0xFDB9D,  0xFDD01,  0xFDE65,  0xFDFC9,  0xFEB36,  0xFEC9A,
    0xFEDFE,  0xFF964,  0xFFAC8,  0xFFC2C,  0x10081E, 0x100982, 0x100AE6,
    0x100C4A, 0x101815, 0x101979, 0x102512, 0x102676, 0x1027DA, 0x103363,
    0x1034C7, 0x10362B, 0x10378F, 0x1038F3, 0x104472, 0x1045D6, 0x105142,
    0x1052A6, 0x10540A, 0x105F8D, 0x1060F1, 0x106255, 0x1063B9, 0x106F1A,
    0x10707E, 0x1071E2, 0x107D1A, 0x107E7E, 0x10899A, 0x108AFE, 0x108C62,
    0x108DC6, 0x108F2A, 0x109A17, 0x109B7B, 0x10A6F2, 0x10A856, 0x10A9BA,
    0x10B4E7, 0x10B64B, 0x10B7AF, 0x10B913, 0x10C461, 0x10C5C5, 0x10C729,
    0x10D24D, 0x10D3B1, 0x10DEBB, 0x10E01F, 0x10E183, 0x10E2E7, 0x10E44B,
    0x10EF1F, 0x10F083, 0x10FB93, 0x10FCF7, 0x10FE5B, 0x10FFBF, 0x110AF4,
    0x110C58, 0x110DBC, 0x110F20, 0x111AC9, 0x111C2D, 0x112752, 0x1128B6,
    0x112A1A, 0x11A833, 0x11A997, 0x11AAFB, 0x11AC5F, 0x11B9C2, 0x11BB26,
    0x11BC8A, 0x11C83A, 0x11C99E, 0x11CB02, 0x11D6BE, 0x11D822, 0x11D986,
    0x11E506, 0x11E66A, 0x11E7CE, 0x11E932, 0x11F3A9, 0x11F50D, 0x11FFCF,
    0x120133, 0x120297, 0x1203FB, 0x12055F, 0x121111, 0x121275, 0x121DBA,
    0x121F1E, 0x122082, 0x122BE5, 0x122D49, 0x122EAD, 0x123011, 0x123BB4,
    0x123D18, 0x123E7C, 0x1249F0, 0x124B54, 0x125747, 0x1258AB, 0x125A0F,
    0x125B73, 0x125CD7, 0x1267EB, 0x12694F, 0x127428, 0x12758C, 0x1276F0,
    0x128255, 0x1283B9, 0x12851D, 0x128681, 0x1291E0, 0x129344, 0x1294A8,
    0x129FB0, 0x12A114, 0x12AC1F, 0x12AD83, 0x12AEE7, 0x12B04B, 0x12B1AF,
    0x12BCC4, 0x12BE28, 0x12BF8C, 0x12CABB, 0x12CC1F, 0x12CD83, 0x12D866,
    0x12D9CA, 0x12DB2E, 0x12E61B, 0x12E77F, 0x12E8E3, 0x12EA47, 0x12F533,
    0x12F697, 0x1303EB, 0x13054F, 0x1306B3, 0x130817, 0x13097B, 0x1314C4,
    0x131F64, 0x1320C8, 0x13222C, 0x132390, 0x132E28, 0x132F8C, 0x1330F0,
    0x133254, 0x133D38, 0x133E9C, 0x134000, 0x134A7D, 0x134BE1, 0x13CF06,
    0x13D06A, 0x13D1CE, 0x13D332, 0x13E2BF, 0x13E423, 0x13E587, 0x13F0F2,
    0x13F256, 0x13F3BA, 0x13FD9E, 0x13FF02, 0x140066, 0x1401CA, 0x140CD6,
    0x140E3A, 0x140F9E, 0x141A78, 0x141BDC, 0x142715, 0x142879, 0x1429DD,
    0x142B41, 0x142CA5, 0x1437AF, 0x143913, 0x14441B, 0x14457F, 0x1446E3,
    0x144847, 0x1453A1, 0x145505, 0x145669, 0x14620F, 0x146373, 0x1464D7,
    0x147061, 0x1471C5, 0x147329, 0x147E75, 0x147FD9, 0x14813D, 0x1482A1,
    0x148E1A, 0x148F7E, 0x149A8F, 0x149BF3, 0x149D57, 0x14A86E, 0x14A9D2,
    0x14AB36, 0x14AC9A, 0x14B7E3, 0x14B947, 0x14BAAB, 0x14BC0F, 0x14C73F,
    0x14D300, 0x14D464, 0x14D5C8, 0x14D72C, 0x14D890, 0x14E35C, 0x14E4C0,
    0x14E624, 0x14F176, 0x14F2DA, 0x14F43E, 0x14FED7, 0x15003B, 0x15019F,
    0x150303, 0x150E2B, 0x150F8F, 0x151AA0, 0x151C04, 0x151D68, 0x15283A,
    0x15299E, 0x152B02, 0x152C66, 0x152DCA, 0x153891, 0x1539F5, 0x154681,
    0x1547E5, 0x154949, 0x1554D6, 0x15563A, 0x15579E, 0x155902, 0x156432,
    0x156596, 0x1566FA, 0x157181, 0x1572E5, 0x15F181, 0x15F2E5, 0x15F449,
    0x15F5AD, 0x15F711, 0x1604BC, 0x160620, 0x1611F9, 0x16135D, 0x1614C1,
    0x161FF4, 0x162158, 0x1622BC, 0x162420, 0x162FA4, 0x163108, 0x16326C,
    0x163DAA, 0x163F0E, 0x1649A9, 0x164B0D, 0x164C71, 0x164DD5, 0x164F39,
    0x1659E7, 0x165B4B, 0x166603, 0x166767, 0x1668CB, 0x166A2F, 0x167580,
    0x1676E4, 0x167848, 0x1679AC, 0x1684A3, 0x168607, 0x16876B, 0x16925A,
    0x1693BE, 0x169F17, 0x16A07B, 0x16A1DF, 0x16A343, 0x16AEAD, 0x16B011,
    0x16B175, 0x16BC23, 0x16BD87, 0x16BEEB, 0x16CA33, 0x16CB97, 0x16CCFB,
    0x16D88C, 0x16D9F0, 0x16DB54, 0x16DCB8, 0x16E7C3, 0x16E927, 0x16F449,
    0x16F5AD, 0x16F711, 0x16F875, 0x16F9D9, 0x1704BF, 0x170623, 0x1711C5,
    0x171329, 0x17148D, 0x172019, 0x17217D, 0x1722E1, 0x172445, 0x172F5C,
    0x1730C0, 0x173224, 0x173D31, 0x173E95, 0x1749CD, 0x174B31, 0x174C95,
    0x174DF9, 0x174F5D, 0x175AF1, 0x175C55, 0x17674B, 0x1768AF, 0x176A13,
    0x1774F0, 0x177654, 0x1777B8, 0x17791C, 0x17840C, 0x178570, 0x1786D4,
    0x178838, 0x17932F, 0x181119, 0x18127D, 0x1813E1, 0x181545, 0x1816A9,
    0x182757, 0x1828BB, 0x182A1F, 0x1834AA, 0x18360E, 0x183772, 0x184184,
    0x1842E8, 0x18444C, 0x184FCA, 0x18512E, 0x185292, 0x185E41, 0x185FA5,
    0x186109, 0x186C2C, 0x186D90, 0x186EF4, 0x187058, 0x1871BC, 0x187CD0,
    0x188831, 0x188995, 0x188AF9, 0x188C5D, 0x18975C, 0x1898C0, 0x189A24,
    0x189B88, 0x18A6D3, 0x18A837, 0x18A99B, 0x18B49D, 0x18B601, 0x18C1C9,
    0x18C32D, 0x18C491, 0x18C5F5, 0x18C759, 0x18D2BD, 0x18D421, 0x18DF3B,
    0x18E09F, 0x18E203, 0x18EC5E, 0x18EDC2, 0x18EF26, 0x18F08A, 0x18FBB5,
    0x18FD19, 0x18FE7D, 0x19099F, 0x190B03, 0x1915EB, 0x19174F, 0x1918B3,
    0x191A17, 0x191B7B, 0x192688, 0x1927EC, 0x19337D, 0x1934E1, 0x193645,
    0x1937A9, 0x1942FD, 0x194461, 0x1945C5, 0x19504E, 0x1951B2, 0x195316,
    0x195F30, 0x196094, 0x1961F8, 0x196C9D, 0x196E01, 0x196F65, 0x1970C9,
    0x197B82, 0x197CE6, 0x19892A, 0x198A8E, 0x198BF2, 0x1996ED, 0x199851,
    0x1999B5, 0x199B19, 0x19A66E, 0x19A7D2, 0x19A936, 0x19AA9A, 0x19B600,
    0x19B764, 0x1A355B, 0x1A36BF, 0x1A3823, 0x1A3987, 0x1A4735, 0x1A4899,
    0x1A49FD, 0x1A55E1, 0x1A5745, 0x1A58A9, 0x1A6422, 0x1A6586, 0x1A66EA,
    0x1A684E, 0x1A71D1, 0x1A7335, 0x1A7499, 0x1A802F, 0x1A8193, 0x1A8DD4,
    0x1A8F38, 0x1A909C, 0x1A9200, 0x1A9364, 0x1A9F04, 0x1AA068, 0x1AAB78,
    0x1AACDC, 0x1AAE40, 0x1AB966, 0x1ABACA, 0x1ABC2E, 0x1ABD92, 0x1AC8F2,
    0x1ACA56, 0x1ACBBA, 0x1AD767, 0x1AD8CB, 0x1AE49A, 0x1AE5FE, 0x1AE762,
    0x1AE8C6, 0x1AEA2A, 0x1AF59F, 0x1AF703, 0x1B0248, 0x1B03AC, 0x1B0510,
    0x1B1002, 0x1B1166, 0x1B12CA, 0x1B142E, 0x1B1F8A, 0x1B20EE, 0x1B2252,
    0x1B2CF1, 0x1B2E55, 0x1B3A56, 0x1B3BBA, 0x1B3D1E, 0x1B3E82, 0x1B3FE6,
    0x1B4B44, 0x1B4CA8, 0x1B581C, 0x1B5980, 0x1B5AE4, 0x1B5C48, 0x1B678F,
    0x1B68F3, 0x1B6A57, 0x1B6BBB, 0x1B76B2, 0x1B7816, 0x1B797A, 0x1B845D,
    0x1B85C1, 0x1B90EE, 0x1B9252, 0x1B93B6, 0x1B951A, 0x1BA06C, 0x1BA1D0,
    0x1BA334, 0x1BADEE, 0x1BAF52, 0x1BB0B6, 0x1BBBF9, 0x1BBD5D, 0x1BBEC1,
    0x1BCA31, 0x1BCB95, 0x1BCCF9, 0x1BCE5D, 0x1BD9CC, 0x1BDB30, 0x1C58D7,
    0x1C5A3B, 0x1C5B9F, 0x1C5D03, 0x1C5E67, 0x1C6C37, 0x1C6D9B, 0x1C799C,
    0x1C7B00, 0x1C7C64, 0x1C865D, 0x1C87C1, 0x1C8925, 0x1C8A89, 0x1C95F9,
    0x1C975D, 0x1C98C1, 0x1CA469, 0x1CA5CD, 0x1CB0DD, 0x1CB241, 0x1CB3A5,
    0x1CB509, 0x1CB66D, 0x1CC234, 0x1CC398, 0x1CCF66, 0x1CD0CA, 0x1CD22E,
    0x1CDDB8, 0x1CDF1C, 0x1CE080, 0x1CE1E4, 0x1CED5A, 0x1CEEBE, 0x1CF022,
    0x1CF186, 0x1CFCAF, 0x1D082D, 0x1D0991, 0x1D0AF5, 0x1D0C59, 0x1D0DBD,
    0x1D1997, 0x1D1AFB, 0x1D1C5F, 0x1D26D6, 0x1D283A, 0x1D3304, 0x1D3468,
    0x1D35CC, 0x1D3730, 0x1D42DC, 0x1D4440, 0x1D45A4, 0x1D512B, 0x1D528F,
    0x1D53F3, 0x1D5EED, 0x1D6051, 0x1D61B5, 0x1D6319, 0x1D647D, 0x1D6F58,
    0x1D7A6E, 0x1D7BD2, 0x1D7D36, 0x1D7E9A, 0x1D899D, 0x1D8B01, 0x1D8C65,
    0x1D8DC9, 0x1D998B, 0x1D9AEF, 0x1D9C53, 0x1DA74F, 0x1DA8B3, 0x1DB418,
    0x1DB57C, 0x1DB6E0, 0x1DB844, 0x1DC314, 0x1DC478, 0x1DC5DC, 0x1DD0D0,
    0x1DD234, 0x1DD398, 0x1DDF0F, 0x1DE073, 0x1DE1D7, 0x1DE33B, 0x1DEDFF,
    0x1DEF63, 0x1DF0C7, 0x1DFBCF, 0x1DFD33, 0x1E7B0F, 0x1E7C73, 0x1E7DD7,
    0x1E7F3B, 0x1E809F, 0x1E8E8B, 0x1E8FEF, 0x1E9C05, 0x1E9D69, 0x1E9ECD,
    0x1EA031, 0x1EAC5D, 0x1EADC1, 0x1EAF25, 0x1EB9BA, 0x1EBB1E, 0x1EBC82,
    0x1EC7C6, 0x1EC92A, 0x1ECA8E, 0x1ED617, 0x1ED77B, 0x1ED8DF, 0x1EDA43,
    0x1EE5CE, 0x1EE732, 0x1EF2A6, 0x1EF40A, 0x1EF56E, 0x1F00C0, 0x1F0224,
    0x1F0388, 0x1F04EC, 0x1F1030, 0x1F1194, 0x1F12F8, 0x1F145C, 0x1F1FCF,
    0x1F2B6D, 0x1F2CD1, 0x1F2E35, 0x1F2F99, 0x1F30FD, 0x1F3CED, 0x1F3E51,
    0x1F3FB5, 0x1F4B6A, 0x1F4CCE, 0x1F4E32, 0x1F58B3, 0x1F5A17, 0x1F5B7B,
    0x1F5CDF, 0x1F6873, 0x1F69D7, 0x1F6B3B, 0x1F765E, 0x1F77C2, 0x1F8313,
    0x1F8477, 0x1F85DB, 0x1F873F, 0x1F88A3, 0x1F9402, 0x1F9566, 0x1FA0D5,
    0x1FA239, 0x1FA39D, 0x1FAE84, 0x1FAFE8, 0x1FB14C, 0x1FB2B0, 0x1FBDD6,
    0x1FBF3A, 0x1FC09E, 0x1FCB9F, 0x1FCD03, 0x1FD87D, 0x1FD9E1, 0x1FDB45,
    0x1FDCA9, 0x1FDE0D, 0x1FEA64, 0x1FEBC8, 0x1FF699, 0x1FF7FD, 0x1FF961,
    0x200489, 0x2005ED, 0x200751, 0x2008B5, 0x2013F2, 0x201556, 0x2016BA,
    0x20181E, 0x202308, 0x20246C};

int Emulation_get_frame(st_frame_info* pOneIpcFrame) {
  unsigned char ptr[PES_HEADER];
  unsigned long long int pts, dts;
  struct timeval tv;
  unsigned long time_current;
  unsigned int FramePLSize;
  unsigned char nonce[AES128_BLOCK_LENGTH] = {};
  unsigned char hash[IOECR_HASH_LENGTH];
  int encrypt_id;

  pOneIpcFrame->size = 0;
  fseek(g_emu_ctx.fp, pes_position[g_emu_ctx.CurFramePosition], SEEK_SET);

  if (fread(ptr, sizeof(unsigned char), PES_HEADER, g_emu_ctx.fp) != PES_HEADER)  // read pes packet header
  {
    if (feof(g_emu_ctx.fp))
      printf("End of file\n");
    else
      printf("Read error\n");
  } else {
    // printf("i=%d\n",i);

    pts = ((unsigned long int)((ptr[9] & 0x0e) >> 1) << 30) |
          ((((ptr[10] << 8) | (ptr[11] & 0xfe)) >> 1) << 15) |
          (((ptr[12] << 8) | (ptr[13] & 0xfe)) >> 1);
    pts = pts /120;
    dts = ((unsigned long int)((ptr[14] & 0x0e) >> 1) << 30) |
          ((((ptr[15] << 8) | (ptr[16] & 0xfe)) >> 1) << 15) |
          (((ptr[17] << 8) | (ptr[18] & 0xfe)) >> 1);
    FramePLSize = pes_position[g_emu_ctx.CurFramePosition + 1] -
                  pes_position[g_emu_ctx.CurFramePosition];

    gettimeofday(&tv, NULL);

    time_current = ((unsigned long)tv.tv_sec) * 1000000 + tv.tv_usec;
    // printf("Time in microsecond:%lld\n",time_current);  //微秒
    if (g_emu_ctx.CurFramePosition == 0) {
      g_emu_ctx.time_start = time_current;  // set time_start
      g_emu_ctx.start_pts = g_emu_ctx.latest_pts;
      printf("Start Time in microsecond:%ld\nStart pts: %ld\n", g_emu_ctx.time_start, g_emu_ctx.start_pts);  //微秒
    } else {
      // printf("Time go:%lld,dts/120:%lld\n",(time_current-
      // time_start),dts*1000/120);
      if ((time_current - g_emu_ctx.time_start) < (dts * 1000 / 120)) {
        return 1;
      }
    }
    pts += g_emu_ctx.start_pts;
    g_emu_ctx.latest_pts = pts;

    pOneIpcFrame->buffer = (unsigned char*)malloc(AES128_BLOCK_LENGTH + FramePLSize + HMAC_OUT_LENGTH);
    if (pOneIpcFrame->buffer == NULL) {
      return 1;
    }
    // read frame payload data
    fread(pOneIpcFrame->buffer + AES128_BLOCK_LENGTH, sizeof(unsigned char), FramePLSize, g_emu_ctx.fp);
    switch (ptr[3]) {
      case 0xe0:  // video frame
        if (*(pOneIpcFrame->buffer + AES128_BLOCK_LENGTH + 4) == 0x47) {
          pOneIpcFrame->frametype = 1;
          // pOneIpcFrame->is_iframe = 1;
        } else {
          pOneIpcFrame->frametype = 0;
          // pOneIpcFrame->is_iframe = 0;
        }
        break;
      case 0xc0:
        pOneIpcFrame->frametype = 0;
        // pOneIpcFrame->is_iframe = 0;
        break;
      default:
        pOneIpcFrame->frametype = 0;
        // pOneIpcFrame->is_iframe = 0;
        break;
    }

    /*
    printf(
        "CurFramePosition=%d,frame_type=0x%02x,codec_id=0x%02x,pts=0x%lx,data_"
        "length=0x%x\n",
        g_emu_ctx.CurFramePosition, pFrameHeader->frame_type,
        pFrameHeader->codec_id, pFrameHeader->pts, pFrameHeader->data_length);
     */

    pOneIpcFrame->size = AES128_BLOCK_LENGTH + FramePLSize + HMAC_OUT_LENGTH;
    pOneIpcFrame->pts = pts;

    // data to send back to caller:
    // aes_encrypt( 16-byte nonce + actual frame + 20-byte hmac-sha1(frame) )

    // attach hmac-sha1(frame) to final 20 bytes
    hmac_sha1(pOneIpcFrame->buffer + AES128_BLOCK_LENGTH, FramePLSize, nonce, AES128_BLOCK_LENGTH, pOneIpcFrame->buffer + AES128_BLOCK_LENGTH + FramePLSize);

    // encrypt the frame data
    encrypt_id = ioecr_encrypt(pOneIpcFrame->buffer + AES128_BLOCK_LENGTH, FramePLSize + HMAC_OUT_LENGTH, nonce, hash);
    if (encrypt_id < 0) {
      free(pOneIpcFrame->buffer);
      pOneIpcFrame->buffer = NULL;
      printf("encryption error\n");
      return encrypt_id;
    }
    memcpy(pOneIpcFrame->buffer, nonce, AES128_BLOCK_LENGTH);
    // pOneIpcFrame->hash = (uint8_t *)strndup((const char *)hash, IOECR_HASH_LENGTH);
    memcpy(pOneIpcFrame->hash, hash, IOECR_HASH_LENGTH);

    g_emu_ctx.CurFramePosition++;
    if (g_emu_ctx.CurFramePosition >= g_emu_ctx.pes_count) g_emu_ctx.CurFramePosition = 0;
  }

  return 0;
}
int Emulation_release_frame(st_frame_info* frameinfo) {
  free(frameinfo->buffer);
  frameinfo->buffer = NULL;
  return 0;
}

void *send_frames(void *arg) {
  st_frame_info frame = {};
  st_emu_context* ctx = arg;
  while (ctx->alive) {
    if (Emulation_get_frame(&frame) != 0) {
      printf("failed to get frame\n");
      continue;
    }
    ioecr_receive_frame(&frame);
    Emulation_release_frame(&frame);
    nanosleep((const struct timespec[]){{0, 5e7L}}, NULL); // sleep and wait for producer
  }
  pthread_exit(NULL);
}

int Emulation_Start(st_emu_context* ctx, pthread_t *thread_id) {
  ctx->fp = fopen("/tmp/test.pes", "rb");
  if (ctx->fp == NULL) {
    printf("Video file open error!\n");
    return 1;
  }
  ctx->CurFramePosition = 0;
  ctx->pes_count = sizeof(pes_position) / sizeof(0) - 1;
  ctx->alive = 1;
  pthread_create(thread_id, NULL, send_frames, (void *)ctx);

  return 0;
}

void Emulation_Stop(st_emu_context* ctx) {
  ctx->alive = 0;
  fclose(ctx->fp);
}

int Emulation_get_credential(st_credential *cre) {
  //cre->uid = strdup("8AXDZ12TMBDUA5UC111A");
  cre->uid = strdup("E7UAA51MKZVCSH6GYHRJ");
  cre->uid_length = strlen(cre->uid);
  //cre->password = strdup("inPzJGpv8UXoeHaqGTJDhRGF2weVOG");
  cre->password = strdup("eTfbY7UpTNOjI2gX03Mf6qAaI7Ph3I");
  cre->password_length = strlen(cre->password);
  return 0;
}

int Emulation_release_credential(st_credential *cre) {
  free(cre->uid);
  free(cre->password);
  return 0;
}
